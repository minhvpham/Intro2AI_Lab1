"""
Exploitation Demo: Simple TSP Problem
======================================
This file demonstrates how HIGH exploitation (high alpha, high beta, low rho) 
allows ACO to quickly converge on a simple TSP problem.

Core Concept:
- High Œ± (pheromone weight): Trust the swarm's learned knowledge
- High Œ≤ (heuristic weight): Trust greedy, distance-based choices
- Low œÅ (evaporation): Preserve learned paths longer

Expected Behavior:
- Fast convergence
- Efficient use of good information
- Risk: May converge to local optimum on complex problems
"""

import numpy as np
import matplotlib.pyplot as plt
import sys
import os

# Add parent directory to path
sys.path.append(os.path.dirname(os.path.dirname(os.path.dirname(__file__))))

from algo1_ACO.tsp.ACO import ACO_TSP_Solver
from utils.tsp import create_cities


def run_exploitation_demo():
    """
    Run ACO on a SIMPLE TSP problem (10 cities) with high exploitation settings.
    """
    print("=" * 70)
    print("EXPLOITATION DEMO: Simple TSP Problem")
    print("=" * 70)
    print("\nScenario: 10 cities - Simple problem")
    print("Strategy: High Exploitation (Quick convergence using known good info)")
    print("\nParameter Settings:")
    
    # Simple problem: fewer cities
    n_cities = 10
    coordinates = create_cities(n_cities, map_size=100, seed=42)
    
    # EXPLOITATION SETTINGS
    exploitation_params = {
        'n_ants': 20,
        'n_iterations': 50,
        'alpha': 2.0,    # HIGH: Trust pheromone trails strongly
        'beta': 5.0,     # HIGH: Trust greedy heuristic strongly
        'rho': 0.1,      # LOW: Slow evaporation (preserve good paths)
        'Q': 100
    }
    
    print(f"  Œ± (alpha) = {exploitation_params['alpha']:.1f} [HIGH - Trust learned paths]")
    print(f"  Œ≤ (beta)  = {exploitation_params['beta']:.1f} [HIGH - Trust greedy choices]")
    print(f"  œÅ (rho)   = {exploitation_params['rho']:.1f} [LOW - Slow evaporation]")
    print(f"  Ants      = {exploitation_params['n_ants']}")
    print(f"  Iterations= {exploitation_params['n_iterations']}")
    
    print("\n" + "-" * 70)
    print("Running ACO with HIGH EXPLOITATION...")
    print("-" * 70 + "\n")
    
    # Run ACO
    aco = ACO_TSP_Solver(coordinates, **exploitation_params)
    best_path, best_length = aco.run()
    
    print("\n" + "=" * 70)
    print(f"RESULT: Best tour length = {best_length:.2f}")
    print("=" * 70)
    
    # Create visualization
    create_exploitation_visualization(aco, coordinates, exploitation_params)
    
    return aco, best_path, best_length


def create_exploitation_visualization(aco, coordinates, params):
    """Create a comprehensive visualization of exploitation behavior."""
    
    fig = plt.figure(figsize=(16, 10))
    
    # 1. Convergence Plot (Top Left)
    ax1 = plt.subplot(2, 3, 1)
    iterations = range(1, len(aco.convergence_history) + 1)
    ax1.plot(iterations, aco.convergence_history, 'b-', linewidth=2, marker='o', markersize=4)
    ax1.set_xlabel('Iteration', fontsize=11, fontweight='bold')
    ax1.set_ylabel('Best Path Length', fontsize=11, fontweight='bold')
    ax1.set_title('Convergence: FAST (Exploitation)', fontsize=12, fontweight='bold')
    ax1.grid(True, alpha=0.3)
    ax1.set_xlim(0, len(aco.convergence_history) + 1)
    
    # Add convergence annotation
    final_value = aco.convergence_history[-1]
    converged_iter = next((i for i, v in enumerate(aco.convergence_history) 
                          if abs(v - final_value) < 0.01 * final_value), len(aco.convergence_history))
    ax1.axvline(x=converged_iter + 1, color='r', linestyle='--', alpha=0.5, linewidth=2)
    ax1.text(converged_iter + 1, ax1.get_ylim()[1] * 0.95, f'Converged\n~iter {converged_iter + 1}',
             ha='center', va='top', fontsize=9, bbox=dict(boxstyle='round', facecolor='yellow', alpha=0.7))
    
    # 2. Best Tour Visualization (Top Middle)
    ax2 = plt.subplot(2, 3, 2)
    path = aco.best_path
    for i in range(len(path) - 1):
        city_a = path[i]
        city_b = path[i + 1]
        ax2.plot([coordinates[city_a, 0], coordinates[city_b, 0]],
                [coordinates[city_a, 1], coordinates[city_b, 1]],
                'b-', linewidth=2, alpha=0.6)
    
    ax2.scatter(coordinates[:, 0], coordinates[:, 1], c='red', s=200, zorder=5, edgecolors='black', linewidths=2)
    
    # Number the cities
    for i, (x, y) in enumerate(coordinates):
        ax2.text(x, y, str(i), fontsize=10, fontweight='bold', ha='center', va='center', color='white')
    
    # Mark start city
    start_city = path[0]
    ax2.scatter([coordinates[start_city, 0]], [coordinates[start_city, 1]], 
               c='lime', s=300, marker='*', zorder=6, edgecolors='black', linewidths=2)
    
    ax2.set_xlabel('X Coordinate', fontsize=11, fontweight='bold')
    ax2.set_ylabel('Y Coordinate', fontsize=11, fontweight='bold')
    ax2.set_title(f'Best Tour (Length: {aco.best_path_length:.2f})', fontsize=12, fontweight='bold')
    ax2.grid(True, alpha=0.3)
    ax2.set_aspect('equal')
    
    # 3. Improvement per Iteration (Top Right)
    ax3 = plt.subplot(2, 3, 3)
    improvements = [aco.iteration_best_lengths[0]]
    for i in range(1, len(aco.iteration_best_lengths)):
        improvement = aco.iteration_best_lengths[i-1] - aco.iteration_best_lengths[i]
        improvements.append(improvement)
    
    ax3.bar(range(1, len(improvements) + 1), improvements, color='green', alpha=0.7, edgecolor='black')
    ax3.set_xlabel('Iteration', fontsize=11, fontweight='bold')
    ax3.set_ylabel('Improvement', fontsize=11, fontweight='bold')
    ax3.set_title('Improvement per Iteration', fontsize=12, fontweight='bold')
    ax3.grid(True, alpha=0.3, axis='y')
    ax3.axhline(y=0, color='r', linestyle='-', linewidth=1)
    
    # 4. Pheromone Heatmap (Bottom Left)
    ax4 = plt.subplot(2, 3, 4)
    im = ax4.imshow(aco.pheromones, cmap='hot', interpolation='nearest')
    ax4.set_xlabel('City', fontsize=11, fontweight='bold')
    ax4.set_ylabel('City', fontsize=11, fontweight='bold')
    ax4.set_title('Final Pheromone Matrix\n(Bright = Strong trails)', fontsize=12, fontweight='bold')
    plt.colorbar(im, ax=ax4, label='Pheromone Level')
    
    # 5. Parameter Settings (Bottom Middle)
    ax5 = plt.subplot(2, 3, 5)
    ax5.axis('off')
    
    param_text = f"""
EXPLOITATION SETTINGS
{'=' * 40}

üî• HIGH Œ± (pheromone) = {params['alpha']:.1f}
   ‚Üí Trust learned paths strongly
   ‚Üí Follow the swarm's knowledge

üî• HIGH Œ≤ (heuristic) = {params['beta']:.1f}
   ‚Üí Trust greedy choices strongly
   ‚Üí Use problem-specific info

‚ùÑÔ∏è  LOW œÅ (evaporation) = {params['rho']:.1f}
   ‚Üí Slow forgetting
   ‚Üí Preserve good trails longer

RESULT:
‚úì Fast convergence (~{converged_iter + 1} iterations)
‚úì Efficient exploitation of good info
‚úì Ideal for SIMPLE problems

TRADE-OFF:
‚ö† Risk of premature convergence
‚ö† May miss global optimum on complex problems
"""
    
    ax5.text(0.1, 0.95, param_text, transform=ax5.transAxes, fontsize=10,
            verticalalignment='top', family='monospace',
            bbox=dict(boxstyle='round', facecolor='wheat', alpha=0.8))
    
    # 6. Convergence Speed Analysis (Bottom Right)
    ax6 = plt.subplot(2, 3, 6)
    
    # Calculate convergence rate
    convergence_rates = []
    for i in range(1, len(aco.convergence_history)):
        rate = (aco.convergence_history[i-1] - aco.convergence_history[i]) / aco.convergence_history[i-1]
        convergence_rates.append(max(0, rate) * 100)  # Convert to percentage
    
    ax6.plot(range(1, len(convergence_rates) + 1), convergence_rates, 'r-', linewidth=2, marker='s', markersize=4)
    ax6.set_xlabel('Iteration', fontsize=11, fontweight='bold')
    ax6.set_ylabel('Improvement Rate (%)', fontsize=11, fontweight='bold')
    ax6.set_title('Convergence Speed\n(High early ‚Üí Fast exploitation)', fontsize=12, fontweight='bold')
    ax6.grid(True, alpha=0.3)
    ax6.set_xlim(0, len(convergence_rates) + 1)
    
    # Add shaded region for fast convergence phase
    fast_phase = min(converged_iter, len(convergence_rates))
    ax6.axvspan(0, fast_phase, alpha=0.2, color='green', label='Fast convergence phase')
    ax6.legend(fontsize=9)
    
    plt.suptitle('ACO EXPLOITATION DEMO: Simple TSP (10 Cities)\nHigh Œ±, High Œ≤, Low œÅ ‚Üí Fast Convergence', 
                 fontsize=14, fontweight='bold', y=0.995)
    plt.tight_layout(rect=[0, 0, 1, 0.99])
    
    # Save figure
    output_path = os.path.join(os.path.dirname(__file__), 'exploitation_demo_results.png')
    plt.savefig(output_path, dpi=150, bbox_inches='tight')
    print(f"\nüìä Visualization saved to: {output_path}")
    
    plt.show()


if __name__ == "__main__":
    print("\n" + "üî•" * 35)
    print("ACO EXPLOITATION DEMONSTRATION")
    print("üî•" * 35 + "\n")
    
    aco, best_path, best_length = run_exploitation_demo()
    
    print("\n" + "=" * 70)
    print("KEY TAKEAWAYS:")
    print("=" * 70)
    print("‚úì High exploitation ‚Üí Fast convergence on simple problems")
    print("‚úì Algorithm quickly finds and reinforces good solutions")
    print("‚úì Efficient when search space is not too complex")
    print("‚úì Trade-off: Risk of missing global optimum on harder problems")
    print("=" * 70 + "\n")
